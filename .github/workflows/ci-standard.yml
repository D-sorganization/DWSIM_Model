name: CI Standard
on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Cross-platform quality gate (Adversarial Assessment Item 5)
  quality-gate:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # NOTE: macOS runners are more expensive than Linux/Windows runners.
        # We intentionally include macos-latest here to enforce the
        # cross-platform "quality-gate" check, accepting the higher cost
        # in exchange for early detection of platform-specific issues.
        os: [ubuntu-latest, windows-latest, macos-latest]
        # To control CI runtime and macOS costs, we only run the quality-gate
        # on a single, officially supported Python version (3.11). Additional
        # Python versions, if needed, should be covered in cheaper, Linux-only
        # jobs rather than expanding the macOS matrix.
        python: ["3.11"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: pip install ruff==0.14.10 black==25.12.0 mypy==1.13.0 bandit==1.7.7 pydocstyle==6.3.0

      # Validate that CI tool versions match pre-commit config
      - name: Check Tool Version Consistency
        shell: bash
        run: |
          echo "Validating tool versions match .pre-commit-config.yaml..."

          # Check Black version
          if ! grep -q "rev: 25.12.0" .pre-commit-config.yaml; then
            echo "::error::Black version mismatch between CI and pre-commit config"
            exit 1
          fi

          # Check Ruff version
          if ! grep -q "rev: v0.14.10" .pre-commit-config.yaml; then
            echo "::error::Ruff version mismatch between CI and pre-commit config"
            exit 1
          fi

          # Check MyPy version
          if ! grep -q "rev: v1.13.0" .pre-commit-config.yaml; then
            echo "::error::MyPy version mismatch between CI and pre-commit config"
            exit 1
          fi

          echo "âœ“ All tool versions are consistent"

      # FIX: Less aggressive Ruff (Errors, Warnings, Imports only)
      - name: Lint
        run: ruff check .

      # FIX: Enforce Black formatting (88 chars)
      - name: Check Formatting
        run: black --check .

      - run: pip install mypy types-PyYAML types-requests
      - run: pip install -r requirements.txt
      - run: mypy python/ --ignore-missing-imports

      # TODO detection now BLOCKING - Jules Auto-Repair will fix
      - name: Verify No Placeholders
        shell: bash
        run: |
          if grep -rE "TODO|FIXME" python/; then
             echo "::error::Placeholders found. Remove TODOs/FIXMEs or create tracked GitHub issues."
             exit 1
          fi

      # FIX: Run Python-based MATLAB Quality Check (Works without License)
      # Non-blocking, archives results for legacy support
      - name: MATLAB Quality Check
        continue-on-error: true
        run: |
          python tools/matlab_utilities/scripts/matlab_quality_check.py --output-format text > matlab_quality_report.txt
          cat matlab_quality_report.txt

      - name: Upload MATLAB Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: matlab-quality-report-${{ matrix.os }}
          path: matlab_quality_report.txt

  # Assessment E: Security scanning for dependency vulnerabilities
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Install pip-audit
        run: pip install pip-audit
      - name: Audit Python Dependencies
        run: |
          echo "Scanning for known vulnerabilities..."
          pip-audit -r requirements.txt --progress-spinner=off

  tests:
    needs: quality-gate
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python: ["3.11"]
        # Windows/macOS test jobs available but not enabled by default (CI cost)
        # Uncomment to enable: os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      - name: Install System Dependencies for PyQt6 (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1 libxkbcommon-x11-0 libdbus-1-3 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xinput0 libxcb-xfixes0 libxcb-shape0 libgl1 xvfb

      - run: pip install -r requirements.txt

      # Run tests (Linux uses xvfb for headless Qt, other platforms run directly)
      - name: Run Tests (Linux)
        if: runner.os == 'Linux'
        run: xvfb-run pytest tests/ -m "not slow and not integration and not benchmark" --cov=python --cov-report=xml

      - name: Run Tests (Windows/macOS)
        if: runner.os != 'Linux'
        run: pytest tests/ -m "not slow and not integration and not benchmark" --cov=python --cov-report=xml
        env:
          QT_QPA_PLATFORM: offscreen
      - uses: codecov/codecov-action@v4
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        if: env.CODECOV_TOKEN != ''
        with:
          fail_ci_if_error: true # BLOCKING: Requires CODECOV_TOKEN secret to be configured
          token: ${{ secrets.CODECOV_TOKEN }}

  javascript-tests:
    needs: quality-gate
    runs-on: ubuntu-latest
    if: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - name: Install & Test
        working-directory: ./javascript
        run: |
          npm ci
          npm run test:coverage

  # =============================================================================
  # MATLAB TESTS - DISABLED BY DEFAULT
  # =============================================================================
  # This job requires a MATLAB license which is NOT available in GitHub CI.
  # DO NOT enable (remove 'if: false') unless you have configured MATLAB licensing.
  # To enable: set 'if: true' and configure matlab-actions.
  # Users with local MATLAB can run: matlab/run_all.m for equivalent tests.
  # =============================================================================
  matlab-tests:
    needs: quality-gate
    runs-on: ubuntu-latest
    if: false  # DISABLED - Requires MATLAB license not available in CI
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: matlab-actions/setup-matlab@v2
      - uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('matlab');
            run_all

  # =============================================================================
  # ARDUINO BUILD - DISABLED BY DEFAULT
  # =============================================================================
  # Enable when Arduino/PlatformIO development is active in this project.
  # =============================================================================
  arduino-build:
    needs: quality-gate
    runs-on: ubuntu-latest
    if: false  # DISABLED - Enable when Arduino development is active
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: pip install platformio
      - name: Verify Build
        working-directory: ./arduino
        run: pio run -e uno

